# -------------------------------------------
# Author : Pierre Aumond, 2019
# noise-planet.org / umrae.fr
# UMRAE, Univ Gustave Eiffel, IFSTTAR, CEREMA, Bouguenais, France
# Licence GPLv3
# If you use/improve this code, please feel free to share your comments and results with us.
# Contact contact@noise-planet.org
# -------------------------------------------

list.of.packages <- c("rgdal", " dplyr ", " rgeos", " sf","dplyr","devtools","leaflet")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]

if(length(new.packages)) install.packages(new.packages)

library(rgdal)
library(dplyr)
library(rgeos)
library(sf)
library(dplyr)
library(devtools)
library(leaflet)

dir <- paste(getwd(),"/data/",sep="")
dirzip <- paste(getwd(),"/unzip/",sep="")
dir.create(dirzip)

list_zip <- list.files(path = dir, pattern = "\\.zip$", all.files = FALSE, full.names = FALSE, recursive = FALSE,ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
xynew<-NA
dfnew<-NA
k <- 1

for(l in list_zip){
  unzip(paste(dir,l,sep=""), exdir= "unzip")
  dirgeojson <- paste(dirzip,"/track.geojson",sep="")
  info <- ogrInfo(dsn= dirgeojson)
  
  if (info$have_features){
    datajson <- readOGR(dsn = dirgeojson,
                        pointDropZ=TRUE, dropNULLGeometries=TRUE )
    
    if (nrow(datajson)>1){
      data <- datajson %>% as.data.frame(.)
      data <- type.convert(data)
      data <- data[c("leq_100", "leq_125", "leq_160","leq_200", "leq_250", "leq_315","leq_400", "leq_500", "leq_630",
                     "leq_800", "leq_1000", "leq_1250","leq_1600", "leq_2000", "leq_2500","leq_3150", "leq_4000", "leq_5000"
                     , "leq_6300", "leq_8000","leq_10000","leq_12500","leq_16000","coords.x1","coords.x2")]
      
      oct <-matrix(NA, nrow = nrow(data), ncol = 8)
      
      oct[,1] <- 10*log10((10^(data[,1]/10))+(10^(data[,2]/10))+(10^(data[,3]/10)))
      oct[,2] <- 10*log10((10^(data[,4]/10))+(10^(data[,5]/10))+(10^(data[,6]/10)))
      oct[,3] <- 10*log10((10^(data[,7]/10))+(10^(data[,8]/10))+(10^(data[,9]/10)))
      oct[,4] <- 10*log10((10^(data[,10]/10))+(10^(data[,11]/10))+(10^(data[,12]/10)))
      oct[,5] <- 10*log10((10^(data[,13]/10))+(10^(data[,14]/10))+(10^(data[,15]/10)))
      oct[,6] <- 10*log10((10^(data[,16]/10))+(10^(data[,17]/10))+(10^(data[,18]/10)))
      oct[,7] <- 10*log10((10^(data[,19]/10))+(10^(data[,18]/10))+(10^(data[,19]/10)))
      oct[,8] <- 10*log10((10^(data[,22]/10))+(10^(data[,23]/10)))
        
      oct <- as.matrix(oct[,1:8])
     
      final <- as.data.frame(data[1:(nrow(data)),24:25],col.names =c("x","y"))
      final$L63 <- oct[,1]
      final$L125 <- oct[,2]
      
      xy <- final[,1:2]
      df <- final[,3:ncol(final)]
      if (length(dfnew)==1){
        dfnew <- df
      }else{
        dfnew <- rbind(df, dfnew)
      }
      xynew <- rbind(xy, xynew)
      
    }
  }
  
  
}


xynew_wthNa <- xynew[-which(is.na(xynew)),] 
dfnew_wthNa <- dfnew[-which(is.na(xynew)),] 

SPDF <- SpatialPointsDataFrame(coords=xynew_wthNa, data=as.data.frame(dfnew_wthNa))
SPDF_sf <- st_as_sf(SPDF, crs = 4326, agr = "constant", remove = F) 

st_crs(SPDF_sf) <- 4326



SPDF_sf_2154 <- st_transform(SPDF_sf, 2154)

bbox <- st_bbox(SPDF_sf_2154)
grid <- sf::st_make_grid(st_as_sfc(bbox),cellsize = 50, square = FALSE)  #Grid of 50 meters
st_crs(grid) <- 2154


stations <- aggregate(x = SPDF_sf_2154, by = grid, FUN = median)         #Calculate median

library(tidyr)
stations <- stations %>% 
  drop_na(geometry) %>% 
  drop_na(L125)

stations_sf <- st_as_sf(stations, crs = 2154, agr = "constant",
                        remove = F) 

stations_sf_4326 <- stations_sf %>% 
  st_transform(4326)

pal2 <- colorQuantile(
  palette = "RdYlGn", n = 11,
  domain = stations$L125, na.color = "transparent")

map <- leaflet(stations_sf_4326) %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addScaleBar( position = c("bottomright"))%>% 
  addPolygons(color = ~pal2(L125), weight = 0, smoothFactor = 0.,
              opacity = 0.0, fillOpacity = 0.7,
              fillColor = ~pal2(L125))
map
